#include <stdio.h>
#include <stdint.h>
#define byte unsigned char
static byte table_0[] = 
{ 99,99,165,198,124,124,132,248,119,119,153,238,123,123,141,246,
242,242,13,255,107,107,189,214,111,111,177,222,197,197,84,145,48,
48,80,96,1,1,3,2,103,103,169,206,43,43,125,86,254,254,25,231,215,
215,98,181,171,171,230,77,118,118,154,236,202,202,69,143,130,130,
157,31,201,201,64,137,125,125,135,250,250,250,21,239,89,89,235,178,
71,71,201,142,240,240,11,251,173,173,236,65,212,212,103,179,162,
162,253,95,175,175,234,69,156,156,191,35,164,164,247,83,114,114,150,
228,192,192,91,155,183,183,194,117,253,253,28,225,147,147,174,61,38,
38,106,76,54,54,90,108,63,63,65,126,247,247,2,245,204,204,79,131,52,
52,92,104,165,165,244,81,229,229,52,209,241,241,8,249,113,113,147,226,
216,216,115,171,49,49,83,98,21,21,63,42,4,4,12,8,199,199,82,149,35,35,
101,70,195,195,94,157,24,24,40,48,150,150,161,55,5,5,15,10,154,154,181,
47,7,7,9,14,18,18,54,36,128,128,155,27,226,226,61,223,235,235,38,205,
39,39,105,78,178,178,205,127,117,117,159,234,9,9,27,18,131,131,158,
29,44,44,116,88,26,26,46,52,27,27,45,54,110,110,178,220,90,90,238,180,
160,160,251,91,82,82,246,164,59,59,77,118,214,214,97,183,179,179,206,
125,41,41,123,82,227,227,62,221,47,47,113,94,132,132,151,19,83,83,245,
166,209,209,104,185,0,0,0,0,237,237,44,193,32,32,96,64,252,252,31,227,
177,177,200,121,91,91,237,182,106,106,190,212,203,203,70,141,190,190,217,
103,57,57,75,114,74,74,222,148,76,76,212,152,88,88,232,176,207,207,74,133,
208,208,107,187,239,239,42,197,170,170,229,79,251,251,22,237,67,67,197,134,
77,77,215,154,51,51,85,102,133,133,148,17,69,69,207,138,249,249,16,233,2,2,
6,4,127,127,129,254,80,80,240,160,60,60,68,120,159,159,186,37,168,168,227,75,
81,81,243,162,163,163,254,93,64,64,192,128,143,143,138,5,146,146,173,63,157,
157,188,33,56,56,72,112,245,245,4,241,188,188,223,99,182,182,193,119,218,218,
117,175,33,33,99,66,16,16,48,32,255,255,26,229,243,243,14,253,210,210,109,191,
205,205,76,129,12,12,20,24,19,19,53,38,236,236,47,195,95,95,225,190,151,151,
162,53,68,68,204,136,23,23,57,46,196,196,87,147,167,167,242,85,126,126,130,
252,61,61,71,122,100,100,172,200,93,93,231,186,25,25,43,50,115,115,149,230,
96,96,160,192,129,129,152,25,79,79,209,158,220,220,127,163,34,34,102,68,42,
42,126,84,144,144,171,59,136,136,131,11,70,70,202,140,238,238,41,199,184,
184,211,107,20,20,60,40,222,222,121,167,94,94,226,188,11,11,29,22,219,219,
118,173,224,224,59,219,50,50,86,100,58,58,78,116,10,10,30,20,73,73,219,
146,6,6,10,12,36,36,108,72,92,92,228,184,194,194,93,159,211,211,110,189,
172,172,239,67,98,98,166,196,145,145,168,57,149,149,164,49,228,228,55,211,
121,121,139,242,231,231,50,213,200,200,67,139,55,55,89,110,109,109,183,218,
141,141,140,1,213,213,100,177,78,78,210,156,169,169,224,73,108,108,180,216,
86,86,250,172,244,244,7,243,234,234,37,207,101,101,175,202,122,122,142,244,
174,174,233,71,8,8,24,16,186,186,213,111,120,120,136,240,37,37,111,74,46,
46,114,92,28,28,36,56,166,166,241,87,180,180,199,115,198,198,81,151,232,
232,35,203,221,221,124,161,116,116,156,232,31,31,33,62,75,75,221,150,189,
189,220,97,139,139,134,13,138,138,133,15,112,112,144,224,62,62,66,124,181,
181,196,113,102,102,170,204,72,72,216,144,3,3,5,6,246,246,1,247,14,14,18,
28,97,97,163,194,53,53,95,106,87,87,249,174,185,185,208,105,134,134,145,
23,193,193,88,153,29,29,39,58,158,158,185,39,225,225,56,217,248,248,19,
235,152,152,179,43,17,17,51,34,105,105,187,210,217,217,112,169,142,142,
137,7,148,148,167,51,155,155,182,45,30,30,34,60,135,135,146,21,233,233,
32,201,206,206,73,135,85,85,255,170,40,40,120,80,223,223,122,165,140,140,
143,3,161,161,248,89,137,137,128,9,13,13,23,26,191,191,218,101,230,230,49,
215,66,66,198,132,104,104,184,208,65,65,195,130,153,153,176,41,45,45,119,90,
15,15,17,30,176,176,203,123,84,84,252,168,187,187,214,109,22,22,58,44, };


#ifndef LOCAL
#define LOCAL
#endif

#define byte unsigned char
typedef uint32_t word;

#define sub_byte(w) {       \
    byte *b = (byte *)&w;   \
    b[0] = table_0[b[0]*4]; \
    b[1] = table_0[b[1]*4]; \
    b[2] = table_0[b[2]*4]; \
    b[3] = table_0[b[3]*4]; \
}
#define rot_up_8(x)   x = (x << 8) | (x >> 24)
#define rot_16(x)     x = (x << 16) | (x >> 16)
#define rot_down_8(x) x = (x >> 8) | (x << 24)
#define table_lookup { \
    p0 = t0[b[0]];     \
    p1 = t0[b[1]];     \
    p2 = t0[b[2]];     \
    p3 = t0[b[3]];     \
}
#define final_mask if(is_final_round) { \
    p0 &= 0xFF;  \
    p1 &= 0xFF00; \
    rot_16(p2);   \
    p2 &= 0xFF0000; \
    rot_down_8(p3); \
    p3 &= 0xFF000000; \
} else { \
    rot_up_8(p0);      \
    rot_16(p1);        \
    rot_down_8(p2);    \
}
#define rot {       \
    rot_up_8(p0);   \
    rot_16(p1);     \
    rot_down_8(p2); \
}


#define prt(x) (print( (unsigned char *) (x)))
#define prtp(x) (print( (unsigned char *) &(x)))
int print(unsigned char *ptr)
{
	printf("0123: %02x %02x %02x %02x\n", (ptr[0])&(0xff), (0xff)&(ptr[1]), (0xff)&(ptr[2]), (0xff)&(ptr[3]) );
}

word gkey[4];
byte grcon;

void encrypt_128_key_expand_inline_no_branch(word state[], word key[]) {
    int nr = 10;
    int i;
    word k0 = key[0], k1 = key[1], k2 = key[2], k3 = key[3];
    state[0] ^= k0;
    state[1] ^= k1;
    state[2] ^= k2;
    state[3] ^= k3;
    word *t0 = (word *)table_0;
    word p0, p1, p2, p3;
    byte *b;
    byte rcon = 1;

    for(i=1; i<nr; i++) {
        word temp = k3;
        rot_down_8(temp);
        sub_byte(temp);  // set b
        temp ^= rcon;
        int j = (char)rcon;
        j <<= 1;
        j ^= (j >> 8) & 0x1B; // if (rcon&0x80 != 0) then (j ^= 0x1B)
        rcon = (byte)j;
        k0 ^= temp;
        k1 ^= k0;
        k2 ^= k1;
        k3 ^= k2;
        word z0 = k0, z1 = k1, z2 = k2, z3 = k3;
        b = (byte *)state; 

        //prtp(state[0]);
        //prt(b);

        table_lookup; 
        //prtp(p0);
        rot; // table: need b, but give p...
        z0 ^= p0, z3 ^= p1, z2 ^= p2, z1 ^= p3;
        b += 4; table_lookup; rot;
        z1 ^= p0, z0 ^= p1, z3 ^= p2, z2 ^= p3;
        b += 4; table_lookup; rot;
        z2 ^= p0, z1 ^= p1, z0 ^= p2, z3 ^= p3;
        b += 4; table_lookup; rot;
        state[0] = z0 ^ p3;
        state[1] = z1 ^ p2;
        state[2] = z2 ^ p1;
        state[3] = z3 ^ p0;

        gkey[0] = k0; gkey[1] = k1; gkey[2] = k2; gkey[3] = k3;
        grcon = rcon;
        return;
    }
    word temp = k3;
    rot_down_8(temp);
    sub_byte(temp);
    temp ^= rcon;
    k0 ^= temp;
    k1 ^= k0;
    k2 ^= k1;
    k3 ^= k2;
    byte *a = (byte *)state, *t = table_0;
    b = (byte *)&k0;
    b[0] ^= t[a[0]*4], b[1] ^= t[a[5]*4], b[2] ^= t[a[10]*4], b[3] ^= t[a[15]*4];
    b = (byte *)&k1;
    b[0] ^= t[a[4]*4], b[1] ^= t[a[9]*4], b[2] ^= t[a[14]*4], b[3] ^= t[a[3]*4];
    b = (byte *)&k2;
    b[0] ^= t[a[8]*4], b[1] ^= t[a[13]*4], b[2] ^= t[a[2]*4], b[3] ^= t[a[7]*4];
    b = (byte *)&k3;
    b[0] ^= t[a[12]*4], b[1] ^= t[a[1]*4], b[2] ^= t[a[6]*4], b[3] ^= t[a[11]*4];
    state[0] = k0;
    state[1] = k1;
    state[2] = k2;
    state[3] = k3;
}

/*
int main()
{
	word plt[4] = {0x1234567,0x2234567,0x3234567,0x4234567};
	prt(plt);
	encrypt_128_key_expand_inline_no_branch(plt,plt);
	
	return 0;
}

*/
